name: Deployment Pipeline

on:
  push:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'

jobs:
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build for staging
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_VERCEL_ENV: staging

    - name: ğŸš€ Deploy to Vercel Staging
      run: |
        npm install -g vercel@latest
        vercel --token ${{ secrets.VERCEL_TOKEN }} --yes
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  create-release-pr:
    name: ğŸ“ Create Release PR
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“ Create Pull Request to Main
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: release/auto-pr-${{ github.run_number }}
        base: main
        head: develop
        title: 'ğŸš€ Release: Deploy develop to production'
        body: |
          ## ğŸš€ Production Release Candidate

          **Staging Deployment**: Successfully deployed to staging âœ…
          **Security Scans**: All security checks passed âœ…
          **Tests**: All tests passing âœ…

          ### ğŸ“‹ Release Checklist
          - [x] Code review completed
          - [x] All CI checks passed
          - [x] Staging deployment successful
          - [x] Security audit completed
          - [ ] Manual QA testing on staging
          - [ ] Performance testing completed
          - [ ] Ready for production deployment

          ### ğŸ”— Links
          - **Staging URL**: Check Vercel deployment
          - **Test Results**: Check Actions tab
          - **Security Report**: Check Security tab

          ### ğŸ“ Changes
          This PR contains all changes from the `develop` branch ready for production deployment.

          **âš ï¸ Review Required**: Manual review and approval required before merging to production.
        labels: |
          release
          auto-generated
        reviewers: |
          ${{ github.actor }}

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build for production
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_VERCEL_ENV: production

    - name: ğŸš€ Deploy to Vercel Production
      run: |
        npm install -g vercel@latest
        vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --yes
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    - name: ğŸ‰ Post-deployment notification
      run: |
        echo "ğŸ‰ Successfully deployed to production!"
        echo "ğŸ”— Production URL: https://your-domain.vercel.app"

  performance-monitoring:
    name: ğŸ“Š Performance Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ“Š Run performance tests
      run: npx tsx scripts/test-deployment.ts
      env:
        NODE_ENV: production
        TARGET_URL: ${{ secrets.PRODUCTION_URL }}

    - name: ğŸ” Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.ref_name }}